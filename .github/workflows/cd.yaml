name: CD Pipeline

on:
    push:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: product-catalog
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '18'

            - name: Install dependencies
              run: npm install

            - name: Build project
              run: npm run build

    code-quality:
        runs-on: ubuntu-latest
        needs: build
        defaults:
            run:
                working-directory: product-catalog
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run ESLint
              run: npx eslint .

            - name: Run tests
              run: npm test

    docker:
        runs-on: ubuntu-latest
        needs: code-quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build Docker image
              run: |
                docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog:${{ github.sha }} ./product-catalog

            - name: Push Docker image
              run: |
                docker push ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog:${{ github.sha }}

            - name: Update deploy.yaml image tag
              run: |
                sed -i "s|image: .*$|image: ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog:${{ github.sha }}|g" deploy.yaml

            - name: Commit and push deploy.yaml
              run: |
                git config --global user.name "github-actions"
                git config --global user.email "github-actions@github.com"
                git add deploy.yaml
                git commit -m "Update image tag in deploy.yaml"
                git push
